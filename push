#!/bin/bash
set -e

usage() {
cat << EOF
Usage: ./"${0}" [OPTIONS] [-]
Push image to DockerHub.

Options:
    --noavx			Push the image without AVX support.
    -h, --help      Print help message.
EOF
}

IMAGE_NAME='mindsync/python'
IMAGE_TAG='gpu-p37-cu11'
PASSWD_FROM_STDIN=0
TAG_SUFFIX=''

while :; do
    case "$1" in 
        -h|--help)
            usage
            exit
            ;;
        --noavx)
            IMAGE_TAG='gpu-p37-cu11-noavx'
            ;;
        --tag-suffix)
            shift
            TAG_SUFFIX="-${1}"
            ;;
        -?*)
            usage
            printf 'ERROR: Unknown option: %s\n' "$1" >&2
            exit
            ;;
        -)
            PASSWD_FROM_STDIN=1
            ;;
        *)            
            break
    esac

    shift
done


set -eux

DOCKER_USERNAME=${DOCKER_USERNAME:-"mindsync"}

if [ "${PASSWD_FROM_STDIN}" -eq 0 ]; then
    docker login -u "${DOCKER_USERNAME}" docker.io
else
    read PASSWD
    echo ${PASSWD} | docker login -u "${DOCKER_USERNAME}" docker.io --password-stdin
fi

docker push "${IMAGE_NAME}:${IMAGE_TAG}${TAG_SUFFIX}"
